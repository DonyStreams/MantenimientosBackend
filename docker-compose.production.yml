version: '3.8'

services:
  # ============================================
  # Backend - Apache TomEE
  # ============================================
  backend:
    container_name: inacif-backend
    build:
      context: .
      dockerfile: Dockerfile.production
    image: inacif/mantenimientos-backend:latest
    restart: unless-stopped
    network_mode: host
    environment:
      # Base de datos
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      # Keycloak
      - KEYCLOAK_URL=${KEYCLOAK_URL}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID_BACKEND}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      # Email
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_ADDRESS=${SMTP_FROM_ADDRESS}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME}
      - SMTP_ADMIN_EMAIL=${SMTP_ADMIN_EMAIL}
      - SMTP_JEFATURA_EMAIL=${SMTP_JEFATURA_EMAIL}
      # Entorno
      - TZ=${TZ:-America/Guatemala}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - JAVA_OPTS=-Xms512m -Xmx2048m -XX:+UseG1GC
      - JAVA_TOOL_OPTIONS=-DDB_HOST=${DB_HOST} -DDB_PORT=${DB_PORT} -DDB_NAME=${DB_NAME} -DDB_USER=${DB_USER} -DDB_PASSWORD=${DB_PASSWORD}
    volumes:
      # Datos persistentes (evidencias, archivos)
      - inacif-data:/opt/inacif-data
      # Logs
      - inacif-logs:/opt/inacif-logs
      # Configuración externa (deshabilitada - se usa .env)
      # - ./config/email.properties:/usr/local/tomee/conf/email.properties:ro
      # - ./config/scheduler.properties:/usr/local/tomee/conf/scheduler.properties:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/MantenimientosBackend/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Frontend - Angular con Nginx
  # ============================================
  frontend:
    container_name: inacif-frontend
    build:
      context: ../EPS-FRONTEND-USAC
      dockerfile: Dockerfile.production
      args:
        - BACKEND_URL=http://${SERVER_URL}:${TOMEE_PORT}/MantenimientosBackend
        - KEYCLOAK_URL=${KEYCLOAK_URL}
        - KEYCLOAK_REALM=${KEYCLOAK_REALM}
        - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID_FRONTEND:-inacif-frontend}
    image: inacif/mantenimientos-frontend:latest
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
    environment:
      - TZ=${TZ:-America/Guatemala}
    networks:
      - inacif-network
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================
# Volúmenes Persistentes
# ============================================
volumes:
  inacif-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${STORAGE_PATH:-/opt/inacif-data}
  
  inacif-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOGS_PATH:-/opt/inacif-logs}

# ============================================
# Red
# ============================================
networks:
  inacif-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
